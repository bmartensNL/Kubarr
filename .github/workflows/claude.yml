name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  # Auto-fix CI failures on claude[bot] PRs
  pull_request:
    types: [opened, synchronize]

jobs:
  claude:
    if: |
      (
        github.event_name == 'pull_request' &&
        startsWith(github.head_ref, 'claude/') &&
        github.event.pull_request.user.login == 'claude[bot]'
      ) ||
      (
        github.actor == 'bmartensNL' && (
          (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
          (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
          (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
          (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
        )
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Allow claude[bot] to trigger this workflow (needed for auto-fix on its own PRs)
          allowed_bots: 'claude[bot]'

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # When triggered by a PR event (CI failure auto-fix), give Claude explicit instructions
          prompt: |
            ${{ github.event_name == 'pull_request' && 'CI is failing on this pull request. Fetch the latest CI logs using the available tools, identify what is failing (lint errors, test failures, build errors, etc.), fix the root cause in the code, and push the fix to this branch. Do not change the PR description or title.' || '' }}

          claude_args: '--dangerously-skip-permissions'

