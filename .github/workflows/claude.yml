name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  # Auto-fix CI failures and review feedback on claude[bot] PRs
  pull_request:
    types: [opened, synchronize]

jobs:
  claude:
    if: |
      (
        github.event_name == 'pull_request' &&
        startsWith(github.head_ref, 'claude/') &&
        github.event.pull_request.user.login == 'claude[bot]'
      ) ||
      (
        github.event_name == 'pull_request_review' &&
        startsWith(github.event.pull_request.head.ref, 'claude/') &&
        github.actor == 'claude[bot]'
      ) ||
      (
        github.actor == 'bmartensNL' && (
          (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
          (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
          (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
          (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
        )
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Allow claude[bot] to trigger this workflow
          allowed_bots: 'claude[bot]'

          additional_permissions: |
            actions: read

          # Context-aware prompt for automated triggers
          prompt: |
            ${{ github.event_name == 'pull_request' && 'CI is failing on this pull request. Use the available tools to fetch the CI logs, identify what is failing (lint errors, test failures, build errors, etc.), fix the root cause in the code, and push the fix to this branch. Do not change the PR description or title.' || '' }}${{ github.event_name == 'pull_request_review' && 'A code review has been submitted on this pull request with feedback and issues to fix. Read the review comments carefully, address every issue raised, and push the fixes to this branch.' || '' }}

          claude_args: '--dangerously-skip-permissions'
