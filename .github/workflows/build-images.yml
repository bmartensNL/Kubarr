name: Build Docker Images

on:
  workflow_call:
    inputs:
      image-tag:
        required: true
        type: string

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Build all images
        run: |
          TAG="${{ inputs.image-tag }}"
          SHA="${{ github.sha }}"
          TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          docker build -f docker/Dockerfile.backend --target test \
            -t "kubarr-backend-test:${TAG}" . &
          PID1=$!

          docker build -f docker/Dockerfile.frontend --target test \
            -t "kubarr-frontend-test:${TAG}" . &
          PID2=$!

          docker build -f docker/Dockerfile.backend \
            -t "kubarr-backend:${TAG}" \
            --build-arg COMMIT_HASH="${SHA}" \
            --build-arg BUILD_TIME="${TIME}" . &
          PID3=$!

          docker build -f docker/Dockerfile.frontend \
            -t "kubarr-frontend:${TAG}" \
            --build-arg COMMIT_HASH="${SHA}" \
            --build-arg BUILD_TIME="${TIME}" . &
          PID4=$!

          wait $PID1 && echo "backend-test done"
          wait $PID2 && echo "frontend-test done"
          wait $PID3 && echo "backend done"
          wait $PID4 && echo "frontend done"
