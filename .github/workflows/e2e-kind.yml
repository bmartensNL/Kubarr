name: E2E Tests (Kind)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  KIND_CLUSTER_NAME: kubarr-e2e

jobs:
  e2e-tests:
    name: E2E Tests with Kind
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install Playwright dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}
          wait: 120s

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images (parallel)
        run: |
          # Build all images in parallel using background jobs
          echo "Building all images in parallel..."

          docker build -f docker/Dockerfile.backend -t kubarr-backend:e2e \
            --build-arg COMMIT_HASH=${{ github.sha }} \
            --build-arg BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ") . &
          PID1=$!

          docker build -f docker/Dockerfile.frontend -t kubarr-frontend:e2e \
            --build-arg COMMIT_HASH=${{ github.sha }} \
            --build-arg BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ") . &
          PID2=$!

          docker build -f docker/Dockerfile.nginx -t kubarr-nginx:e2e . &
          PID3=$!

          # Wait for all builds to complete
          wait $PID1 && echo "Backend build done" || exit 1
          wait $PID2 && echo "Frontend build done" || exit 1
          wait $PID3 && echo "Nginx build done" || exit 1

          echo "All images built successfully!"

      - name: Load images into Kind
        run: |
          kind load docker-image kubarr-backend:e2e --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image kubarr-frontend:e2e --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image kubarr-nginx:e2e --name ${{ env.KIND_CLUSTER_NAME }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Generate secrets
        run: |
          # Generate JWT keys for Kubarr
          openssl genrsa -out /tmp/jwt-private.pem 2048
          openssl rsa -in /tmp/jwt-private.pem -pubout -out /tmp/jwt-public.pem

          # Generate OAuth2 secrets
          COOKIE_SECRET=$(openssl rand -base64 32 | tr -d '\n' | head -c 32)
          CLIENT_SECRET="e2e-test-client-secret-12345"

          # Store for later use
          echo "COOKIE_SECRET=$COOKIE_SECRET" >> $GITHUB_ENV
          echo "CLIENT_SECRET=$CLIENT_SECRET" >> $GITHUB_ENV

      - name: Deploy Kubarr
        run: |
          # Create namespace first
          kubectl create namespace kubarr --dry-run=client -o yaml | kubectl apply -f -

          # Create JWT secret with correct name (kubarr-jwt-keys)
          kubectl create secret generic kubarr-jwt-keys \
            --from-file=private.pem=/tmp/jwt-private.pem \
            --from-file=public.pem=/tmp/jwt-public.pem \
            -n kubarr \
            --dry-run=client -o yaml | kubectl apply -f -

          # Deploy kubarr chart
          helm upgrade --install kubarr ./charts/kubarr \
            --namespace kubarr \
            --set namespace.create=false \
            --set backend.image.repository=kubarr-backend \
            --set backend.image.tag=e2e \
            --set backend.image.pullPolicy=Never \
            --set frontend.image.repository=kubarr-frontend \
            --set frontend.image.tag=e2e \
            --set frontend.image.pullPolicy=Never \
            --set oauth2.enabled=true \
            --set auth.jwt.existingSecret=kubarr-jwt-keys \
            --set networkPolicy.enabled=false \
            --set podSecurityContext.runAsNonRoot=false \
            --set podSecurityContext.runAsUser=0 \
            --set podSecurityContext.fsGroup=0 \
            --wait --timeout=5m

      - name: Deploy Nginx
        run: |
          # Create namespace
          kubectl create namespace nginx --dry-run=client -o yaml | kubectl apply -f -

          # Deploy nginx chart
          helm upgrade --install nginx ./charts/nginx \
            --namespace nginx \
            --set namespace.create=false \
            --set image.repository=kubarr-nginx \
            --set image.tag=e2e \
            --set image.pullPolicy=Never \
            --set networkPolicy.enabled=false \
            --wait --timeout=3m

      - name: Deploy OAuth2-Proxy
        run: |
          # Deploy oauth2-proxy chart (it creates its own secret from values)
          helm upgrade --install oauth2-proxy ./charts/oauth2-proxy \
            --namespace oauth2-proxy \
            --create-namespace \
            --set config.clientId=oauth2-proxy \
            --set config.clientSecret="${CLIENT_SECRET}" \
            --set config.cookieSecret="${COOKIE_SECRET}" \
            --set provider.issuerUrl=http://kubarr.kubarr.svc.cluster.local:8000/auth \
            --set config.redirectUrl=http://localhost:8080/oauth2/callback \
            --set config.upstreams[0]=http://nginx.nginx.svc.cluster.local:8080 \
            --set networkPolicy.enabled=false \
            --wait --timeout=5m

      - name: Wait for all pods
        run: |
          echo "Waiting for Kubarr backend..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kubarr -n kubarr --timeout=180s || true

          echo "Waiting for Kubarr frontend..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kubarr-frontend -n kubarr --timeout=120s || true

          echo "Waiting for Nginx..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=nginx -n nginx --timeout=120s || true

          echo "Waiting for OAuth2-Proxy..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=oauth2-proxy -n oauth2-proxy --timeout=180s || true

          echo ""
          echo "=== All Pods Status ==="
          kubectl get pods -A
          echo ""
          echo "=== Services ==="
          kubectl get svc -A

      - name: Debug - Show logs if pods not ready
        if: always()
        run: |
          echo "=== Kubarr Backend Logs ==="
          kubectl logs -l app.kubernetes.io/name=kubarr -n kubarr --tail=50 2>/dev/null || echo "No logs available"

          echo ""
          echo "=== Kubarr Frontend Logs ==="
          kubectl logs -l app.kubernetes.io/name=kubarr-frontend -n kubarr --tail=50 2>/dev/null || echo "No logs available"

          echo ""
          echo "=== Nginx Logs ==="
          kubectl logs -l app.kubernetes.io/name=nginx -n nginx --tail=50 2>/dev/null || echo "No logs available"

          echo ""
          echo "=== OAuth2-Proxy Logs ==="
          kubectl logs -l app.kubernetes.io/name=oauth2-proxy -n oauth2-proxy --tail=50 2>/dev/null || echo "No logs available"

          echo ""
          echo "=== Pod Descriptions (if any failed) ==="
          kubectl describe pods -n kubarr 2>/dev/null | tail -100 || true
          kubectl describe pods -n oauth2-proxy 2>/dev/null | tail -100 || true

      - name: Setup port-forwards
        run: |
          # Port-forward backend directly for setup (port 8000)
          kubectl port-forward svc/kubarr 8000:8000 -n kubarr &
          echo $! > /tmp/pf_backend_pid

          # Port-forward oauth2-proxy for E2E tests (port 8080)
          kubectl port-forward svc/oauth2-proxy 8080:80 -n oauth2-proxy &
          echo $! > /tmp/pf_oauth_pid

          # Wait for backend port-forward
          echo "Waiting for backend port-forward..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/api/system/health 2>/dev/null | grep -q "ok"; then
              echo "Backend port-forward ready!"
              break
            fi
            echo "Attempt $i: waiting for backend..."
            sleep 2
          done

          # Wait for oauth2-proxy port-forward
          echo "Waiting for oauth2-proxy port-forward..."
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 2>/dev/null | grep -qE "200|302|401|403"; then
              echo "OAuth2-proxy port-forward ready!"
              break
            fi
            echo "Attempt $i: waiting for oauth2-proxy..."
            sleep 2
          done

      - name: Initialize Kubarr setup
        run: |
          echo "Checking backend health..."
          curl -s http://localhost:8000/api/system/health || echo "Health check failed"

          echo ""
          echo "Running initial setup via port-forward..."
          SETUP_RESPONSE=$(curl -s -X POST \
            http://localhost:8000/api/setup/initialize \
            -H "Content-Type: application/json" \
            -d '{
              "admin_username": "admin",
              "admin_email": "admin@test.local",
              "admin_password": "admin",
              "storage_path": "/data",
              "base_url": "http://localhost:8080"
            }') || true

          echo "Setup response: $SETUP_RESPONSE"

          # Verify admin user can be used
          if echo "$SETUP_RESPONSE" | grep -qE "success|admin|oauth2"; then
            echo "Setup completed successfully!"
          else
            echo "Setup response: $SETUP_RESPONSE"
            echo "Attempting to check setup status..."
            curl -s http://localhost:8000/api/setup/status || true
          fi

      - name: Verify OAuth login flow
        run: |
          echo "Testing OAuth login endpoint..."

          # Test 1: Check that oauth2-proxy redirects to login page
          REDIRECT=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)
          echo "OAuth2-proxy root redirect status: $REDIRECT"

          # Test 2: Check that the auth login page is reachable via the backend
          echo ""
          echo "Checking auth login page..."
          curl -s http://localhost:8000/auth/login -o /dev/null -w "Auth login page HTTP status: %{http_code}\n" || true

          # Test 3: Try to authenticate via the backend directly
          echo ""
          echo "Testing direct authentication..."
          LOGIN_RESPONSE=$(curl -s -X POST http://localhost:8000/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"admin"}' 2>&1) || true
          echo "Login response: $LOGIN_RESPONSE"

          # Test 4: Check that oauth2-proxy can reach the backend
          echo ""
          echo "Checking oauth2-proxy -> backend connectivity..."
          curl -s -v http://localhost:8080/ 2>&1 | head -30 || true

      - name: Run Playwright tests
        run: npm test -- --project=chromium
        env:
          BASE_URL: http://localhost:8080
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: test-results/
          retention-days: 14

      - name: Cleanup
        if: always()
        run: |
          if [ -f /tmp/pf_pid ]; then
            kill $(cat /tmp/pf_pid) 2>/dev/null || true
          fi
