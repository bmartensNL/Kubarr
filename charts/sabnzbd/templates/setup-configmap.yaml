apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sabnzbd.fullname" . }}-setup
  namespace: {{ .Values.namespace.name }}
  labels:
    {{- include "sabnzbd.labels" . | nindent 4 }}
data:
  setup-apikey.sh: |
    #!/bin/bash
    # Setup script to configure SABnzbd with a known API key
    # This allows Radarr/Sonarr to auto-discover and connect to SABnzbd

    CONFIG_FILE="/config/sabnzbd.ini"
    # Use a stable API key that Radarr/Sonarr can use
    API_KEY="kubarr-sabnzbd-api-key-12345"

    echo "[setup] SABnzbd API key setup starting..."

    # Wait for SABnzbd to create initial config
    MAX_WAIT=120
    WAITED=0
    while [ ! -f "$CONFIG_FILE" ]; do
      if [ $WAITED -ge $MAX_WAIT ]; then
        echo "[setup] Timeout waiting for SABnzbd config file"
        exit 0  # Don't fail, SABnzbd will create it eventually
      fi
      echo "[setup] Waiting for SABnzbd to create config file..."
      sleep 5
      WAITED=$((WAITED + 5))
    done

    echo "[setup] Config file found, checking API key..."

    # Check if API key is already set to our known value
    CURRENT_KEY=$(grep -E "^api_key\s*=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')

    if [ "$CURRENT_KEY" = "$API_KEY" ]; then
      echo "[setup] API key already configured correctly"
      exit 0
    fi

    # Wait a moment for SABnzbd to finish initial setup
    sleep 10

    # Update or add the API key
    if grep -q "^api_key" "$CONFIG_FILE" 2>/dev/null; then
      echo "[setup] Updating existing API key..."
      sed -i "s/^api_key.*/api_key = $API_KEY/" "$CONFIG_FILE"
    else
      echo "[setup] Adding API key to config..."
      # Find the [misc] section and add the api_key there
      if grep -q "^\[misc\]" "$CONFIG_FILE"; then
        sed -i "/^\[misc\]/a api_key = $API_KEY" "$CONFIG_FILE"
      else
        # If no [misc] section, add it
        echo -e "\n[misc]\napi_key = $API_KEY" >> "$CONFIG_FILE"
      fi
    fi

    # Also set nzb_key for NZB uploads
    if grep -q "^nzb_key" "$CONFIG_FILE" 2>/dev/null; then
      sed -i "s/^nzb_key.*/nzb_key = $API_KEY/" "$CONFIG_FILE"
    else
      if grep -q "^\[misc\]" "$CONFIG_FILE"; then
        sed -i "/^\[misc\]/a nzb_key = $API_KEY" "$CONFIG_FILE"
      fi
    fi

    # Disable local_ranges restriction to allow connections from other pods
    if grep -q "^local_ranges" "$CONFIG_FILE" 2>/dev/null; then
      sed -i "s/^local_ranges.*/local_ranges = 10.0.0.0\/8, 172.16.0.0\/12, 192.168.0.0\/16/" "$CONFIG_FILE"
    else
      if grep -q "^\[misc\]" "$CONFIG_FILE"; then
        sed -i "/^\[misc\]/a local_ranges = 10.0.0.0\/8, 172.16.0.0\/12, 192.168.0.0\/16" "$CONFIG_FILE"
      fi
    fi

    echo "[setup] SABnzbd API key configured successfully"
    echo "[setup] Note: SABnzbd may need a restart to pick up changes"
