apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "oauth2-proxy.fullname" . }}-config
  namespace: {{ .Values.namespace.name }}
  labels:
    {{- include "oauth2-proxy.labels" . | nindent 4 }}
data:
  oauth2-proxy.cfg: |
    # Provider configuration
    provider = "oidc"
    oidc_issuer_url = "{{ .Values.provider.issuerUrl }}"
    skip_oidc_discovery = true

    # Manual endpoint configuration
    # login_url must be browser-accessible, others go through nginx which routes to backend
    login_url = "http://localhost:8080/auth/authorize"
    redeem_url = "http://nginx.nginx.svc.cluster.local:8080/auth/token"
    validate_url = "http://nginx.nginx.svc.cluster.local:8080/auth/userinfo"
    oidc_jwks_url = "http://nginx.nginx.svc.cluster.local:8080/auth/jwks"

    # Skip the "Sign in with..." button and redirect directly to provider
    skip_provider_button = true

    # Client configuration
    client_id = "{{ .Values.config.clientId }}"
    redirect_url = "{{ .Values.config.redirectUrl }}"

    # Cookie configuration
    cookie_name = "kubarr_auth"
    cookie_httponly = true
    cookie_samesite = "lax"
    cookie_expire = "{{ .Values.config.cookieExpire }}"
    cookie_secure = false
    # cookie_domains not set - use request host for cookies
    cookie_csrf_per_request = true
    cookie_csrf_expire = "5m"

    # Email domain restrictions
    {{- if .Values.config.emailDomains }}
    email_domains = [
      {{- range .Values.config.emailDomains }}
      "{{ . }}",
      {{- end }}
    ]
    {{- else }}
    email_domains = ["*"]
    {{- end }}

    # Skip provider verification for internal services
    ssl_insecure_skip_verify = true

    # Upstream configuration (proxying to nginx service for path-based routing)
    upstreams = [
      "http://nginx.nginx.svc.cluster.local:8080",
    ]

    # Logging
    request_logging = true
    auth_logging = true
    standard_logging = true

    # Session configuration
    session_store_type = "cookie"

    # HTTP configuration
    http_address = "0.0.0.0:4180"

    # Pass user info headers to upstream (nginx strips them from responses)
    # Enable access token forwarding for nginx JWT validation
    pass_access_token = true
    pass_authorization_header = true
    pass_user_headers = true
    set_authorization_header = true
    set_xauthrequest = true

    # Use email claim for X-Auth-Request-User header instead of sub
    user_id_claim = "email"

    # Skip authentication for these paths (auth endpoints to prevent redirect loop)
    skip_auth_routes = [
      "^/ping$",
      "^/ready$",
      "^/auth/.*",
      "^/login$",
      "^/assets/.*",
      "^/favicon\\.svg$",
      "^/api/apps/catalog/[^/]+/icon$",
      "^/api/setup/required$"
    ]

    # Allow redirect to any path on same domain after sign out
    whitelist_domains = [".localhost:8080", "localhost:8080"]
