apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "oauth2-proxy.fullname" . }}-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "oauth2-proxy.labels" . | nindent 4 }}
data:
  oauth2-proxy.cfg: |
    # Provider configuration
    provider = "oidc"
    oidc_issuer_url = "{{ .Values.provider.issuerUrl }}"
    skip_oidc_discovery = true

    # Manual endpoint configuration for internal service communication
    login_url = "http://kubarr-dashboard.kubarr-system.svc.cluster.local:8000/auth/authorize"
    redeem_url = "http://kubarr-dashboard.kubarr-system.svc.cluster.local:8000/auth/token"
    validate_url = "http://kubarr-dashboard.kubarr-system.svc.cluster.local:8000/auth/userinfo"
    oidc_jwks_url = "http://kubarr-dashboard.kubarr-system.svc.cluster.local:8000/auth/jwks"

    # Client configuration
    client_id = "{{ .Values.config.clientId }}"
    redirect_url = "{{ .Values.config.redirectUrl }}"

    # Cookie configuration
    cookie_name = "_oauth2_proxy"
    cookie_httponly = true
    cookie_samesite = "lax"
    cookie_expire = "{{ .Values.config.cookieExpire }}"
    cookie_secure = false

    # Email domain restrictions
    {{- if .Values.config.emailDomains }}
    email_domains = [
      {{- range .Values.config.emailDomains }}
      "{{ . }}",
      {{- end }}
    ]
    {{- else }}
    email_domains = ["*"]
    {{- end }}

    # Skip provider verification for internal services
    ssl_insecure_skip_verify = true

    # Upstream configuration (proxying to media apps)
    upstreams = [
      {{- range .Values.config.upstreams }}
      "{{ . }}",
      {{- end }}
    ]

    # Logging
    request_logging = true
    auth_logging = true
    standard_logging = true

    # Session configuration
    session_store_type = "cookie"

    # HTTP configuration
    http_address = "0.0.0.0:4180"

    # Pass headers to upstream
    pass_access_token = true
    pass_authorization_header = true
    pass_user_headers = true
    set_authorization_header = true
    set_xauthrequest = true

    # Skip authentication for these paths
    skip_auth_routes = [
      "^/ping$",
      "^/ready$"
    ]
