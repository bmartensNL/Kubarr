apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "oauth2-proxy.fullname" . }}-nginx-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "oauth2-proxy.labels" . | nindent 4 }}
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        # MIME types
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Use Kubernetes DNS resolver with short TTL to prevent IP caching
        resolver kube-dns.kube-system.svc.cluster.local valid=5s;

        server {
            listen 8080;
            server_name _;

            # Proxy qbittorrent - use variable to force dynamic DNS resolution
            location /qbittorrent/ {
                set $qbittorrent_upstream qbittorrent.qbittorrent.svc.cluster.local:8080;
                rewrite ^/qbittorrent/(.*) /$1 break;
                proxy_pass http://$qbittorrent_upstream;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_hide_header X-Content-Type-Options;
            }

            # Proxy jackett - use variable to force dynamic DNS resolution
            # Note: Don't strip /jackett prefix - Jackett handles it with BasePathOverride
            location /jackett {
                set $jackett_upstream jackett.jackett.svc.cluster.local:9117;
                proxy_pass http://$jackett_upstream;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto http;
                proxy_set_header X-Forwarded-Host $http_host;
                proxy_redirect https:// http://;

                # Hide Jackett's security warning (oauth2-proxy handles auth)
                sub_filter_once off;
                sub_filter_types text/html;
                sub_filter 'id="jackett-security"' 'id="jackett-security" style="display:none"';
            }

            # Proxy sonarr - use variable to force dynamic DNS resolution
            location /sonarr {
                set $sonarr_upstream sonarr.sonarr.svc.cluster.local:8989;
                proxy_pass http://$sonarr_upstream;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto http;
                proxy_set_header X-Forwarded-Host $http_host;
                proxy_redirect https:// http://;
            }

            # Proxy radarr - use variable to force dynamic DNS resolution
            location /radarr {
                set $radarr_upstream radarr.radarr.svc.cluster.local:7878;
                proxy_pass http://$radarr_upstream;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto http;
                proxy_set_header X-Forwarded-Host $http_host;
                proxy_redirect https:// http://;
            }

            # Proxy transmission - use variable to force dynamic DNS resolution
            location /transmission/ {
                set $transmission_upstream transmission.transmission.svc.cluster.local:9091;
                proxy_pass http://$transmission_upstream;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Proxy deluge - use variable to force dynamic DNS resolution
            location /deluge/ {
                set $deluge_upstream deluge.deluge.svc.cluster.local:8112;
                rewrite ^/deluge/(.*) /$1 break;
                proxy_pass http://$deluge_upstream;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                # Rewrite paths in HTML/JS responses to include /deluge/ prefix
                sub_filter_once off;
                sub_filter_types text/html text/css application/javascript;
                sub_filter 'src="/' 'src="/deluge/';
                sub_filter "src='/" "src='/deluge/";
                sub_filter 'href="/' 'href="/deluge/';
                sub_filter "href='/" "href='/deluge/";
                sub_filter 'url(/' 'url(/deluge/';
                sub_filter '"/json"' '"/deluge/json"';
                sub_filter "'/json'" "'/deluge/json'";
            }

            # Proxy ruTorrent - use variable to force dynamic DNS resolution
            location /rutorrent/ {
                set $rutorrent_upstream rutorrent.rutorrent.svc.cluster.local:8080;
                rewrite ^/rutorrent/(.*) /$1 break;
                proxy_pass http://$rutorrent_upstream;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Proxy jellyfin - use variable to force dynamic DNS resolution
            location /jellyfin/ {
                set $jellyfin_upstream jellyfin.jellyfin.svc.cluster.local:8096;
                rewrite ^/jellyfin/(.*) /$1 break;
                proxy_pass http://$jellyfin_upstream;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Proxy jellyseerr - use variable to force dynamic DNS resolution
            location /jellyseerr/ {
                set $jellyseerr_upstream jellyseerr.jellyseerr.svc.cluster.local:5055;
                rewrite ^/jellyseerr/(.*) /$1 break;
                proxy_pass http://$jellyseerr_upstream;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Proxy sabnzbd - use variable to force dynamic DNS resolution
            location /sabnzbd/ {
                set $sabnzbd_upstream sabnzbd.sabnzbd.svc.cluster.local:8080;
                rewrite ^/sabnzbd/(.*) /$1 break;
                proxy_pass http://$sabnzbd_upstream;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Default to kubarr dashboard - use variable to force dynamic DNS resolution
            location / {
                set $kubarr_upstream kubarr-dashboard.kubarr-system.svc.cluster.local:8000;
                proxy_pass http://$kubarr_upstream;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Authorization $http_authorization;
            }
        }
    }
