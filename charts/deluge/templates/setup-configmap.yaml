apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "deluge.fullname" . }}-setup
  namespace: {{ .Values.namespace.name }}
  labels:
    {{- include "deluge.labels" . | nindent 4 }}
data:
  enable-label-plugin.sh: |
    #!/bin/bash
    # Enable the Label plugin in Deluge for Radarr/Sonarr integration

    CONFIG_DIR="/config"
    CORE_CONF="$CONFIG_DIR/core.conf"
    LABEL_CONF="$CONFIG_DIR/label.conf"

    echo "[deluge-setup] Checking Label plugin configuration..."

    # Wait for Deluge to create initial config (if first run)
    sleep 5

    # Check if core.conf exists
    if [ -f "$CORE_CONF" ]; then
      # Check if Label plugin is already enabled
      if grep -q '"Label"' "$CORE_CONF"; then
        echo "[deluge-setup] Label plugin is already enabled"
      else
        echo "[deluge-setup] Enabling Label plugin in core.conf..."
        # Add Label to enabled_plugins list
        if grep -q '"enabled_plugins": \[\]' "$CORE_CONF"; then
          # Empty enabled_plugins array - add Label
          sed -i 's/"enabled_plugins": \[\]/"enabled_plugins": ["Label"]/' "$CORE_CONF"
        elif grep -q '"enabled_plugins": \[' "$CORE_CONF"; then
          # Has other plugins - append Label
          sed -i 's/"enabled_plugins": \[/"enabled_plugins": ["Label", /' "$CORE_CONF"
        else
          echo "[deluge-setup] Could not find enabled_plugins in core.conf"
        fi
      fi
    else
      echo "[deluge-setup] core.conf not found, creating default with Label plugin enabled..."
      # Create minimal core.conf with Label plugin enabled
      cat > "$CORE_CONF" << 'COREEOF'
    {
        "file": 1,
        "format": 1
    }{
        "add_paused": false,
        "allow_remote": true,
        "auto_managed": true,
        "copy_torrent_file": false,
        "daemon_port": 58846,
        "del_copy_torrent_file": false,
        "download_location": "/downloads",
        "enabled_plugins": ["Label"],
        "listen_ports": [6881, 6891],
        "max_active_downloading": 3,
        "max_active_limit": 8,
        "max_active_seeding": 5,
        "max_connections_global": 200,
        "max_download_speed": -1.0,
        "max_upload_slots_global": 4,
        "max_upload_speed": -1.0,
        "move_completed": false,
        "move_completed_path": "/downloads",
        "new_release_check": false,
        "pre_allocate_storage": false,
        "prioritize_first_last_pieces": false,
        "random_port": true,
        "remove_seed_at_ratio": false,
        "seed_time_limit": 180,
        "seed_time_ratio_limit": 7.0,
        "send_info": false,
        "stop_seed_at_ratio": false,
        "stop_seed_ratio": 2.0
    }
    COREEOF
    fi

    # Create label.conf if it doesn't exist (required for the Label plugin)
    if [ ! -f "$LABEL_CONF" ]; then
      echo "[deluge-setup] Creating label.conf..."
      cat > "$LABEL_CONF" << 'LABELEOF'
    {
        "file": 1,
        "format": 1
    }{
        "labels": {}
    }
    LABELEOF
    fi

    echo "[deluge-setup] Label plugin configuration complete"
