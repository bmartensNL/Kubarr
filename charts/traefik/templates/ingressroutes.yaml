apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: forward-auth
  namespace: {{ .Values.namespace.name }}
spec:
  forwardAuth:
    address: http://traefik-forward-auth.{{ .Values.namespace.name }}.svc.cluster.local:4181
    authResponseHeaders:
      - X-Forwarded-User
      - X-Auth-User
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-qbittorrent
  namespace: {{ .Values.namespace.name }}
spec:
  stripPrefix:
    prefixes:
      - /qbittorrent
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-transmission
  namespace: {{ .Values.namespace.name }}
spec:
  stripPrefix:
    prefixes:
      - /transmission
---
# Public routes (no auth)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: public-routes
  namespace: {{ .Values.namespace.name }}
spec:
  entryPoints:
    - web
  routes:
    # Health check
    - match: Path(`/healthz`)
      kind: Rule
      services:
        - name: traefik
          port: 8080
      middlewares: []

    # Auth endpoints (backend handles these)
    - match: PathPrefix(`/auth`)
      kind: Rule
      services:
        - name: kubarr
          namespace: kubarr
          port: 8000

    # OAuth callback - goes through forward-auth middleware which intercepts it
    - match: PathPrefix(`/_oauth`)
      kind: Rule
      middlewares:
        - name: forward-auth
      services:
        - name: traefik
          port: 8080

    # Setup required endpoint (public)
    - match: Path(`/api/setup/required`)
      kind: Rule
      services:
        - name: kubarr
          namespace: kubarr
          port: 8000

    # App icons (public)
    - match: PathPrefix(`/api/apps/catalog`) && PathRegexp(`^/api/apps/catalog/[^/]+/icon$`)
      kind: Rule
      services:
        - name: kubarr
          namespace: kubarr
          port: 8000

    # Static assets
    - match: PathPrefix(`/assets`) || Path(`/favicon.svg`)
      kind: Rule
      services:
        - name: kubarr-frontend
          namespace: kubarr
          port: 80
---
# Protected routes (require auth)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: protected-routes
  namespace: {{ .Values.namespace.name }}
spec:
  entryPoints:
    - web
  routes:
    # qBittorrent
    - match: PathPrefix(`/qbittorrent`)
      kind: Rule
      middlewares:
        - name: forward-auth
        - name: strip-qbittorrent
      services:
        - name: qbittorrent
          namespace: qbittorrent
          port: 8080

    # Jackett
    - match: PathPrefix(`/jackett`)
      kind: Rule
      middlewares:
        - name: forward-auth
      services:
        - name: jackett
          namespace: jackett
          port: 9117

    # Sonarr
    - match: PathPrefix(`/sonarr`)
      kind: Rule
      middlewares:
        - name: forward-auth
      services:
        - name: sonarr
          namespace: sonarr
          port: 8989

    # Radarr
    - match: PathPrefix(`/radarr`)
      kind: Rule
      middlewares:
        - name: forward-auth
      services:
        - name: radarr
          namespace: radarr
          port: 7878

    # Transmission
    - match: PathPrefix(`/transmission`)
      kind: Rule
      middlewares:
        - name: forward-auth
        - name: strip-transmission
      services:
        - name: transmission
          namespace: transmission
          port: 9091

    # Grafana
    - match: PathPrefix(`/grafana`)
      kind: Rule
      middlewares:
        - name: forward-auth
      services:
        - name: grafana
          namespace: grafana
          port: 3000

    # Loki
    - match: PathPrefix(`/loki`)
      kind: Rule
      middlewares:
        - name: forward-auth
      services:
        - name: loki
          namespace: loki
          port: 3100

    # API endpoints
    - match: PathPrefix(`/api`)
      kind: Rule
      middlewares:
        - name: forward-auth
      services:
        - name: kubarr
          namespace: kubarr
          port: 8000

    # SPA fallback - all other routes serve frontend
    - match: PathPrefix(`/`)
      kind: Rule
      priority: 1
      middlewares:
        - name: forward-auth
      services:
        - name: kubarr-frontend
          namespace: kubarr
          port: 80
