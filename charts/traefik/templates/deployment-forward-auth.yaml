apiVersion: apps/v1
kind: Deployment
metadata:
  name: traefik-forward-auth
  namespace: {{ .Values.namespace.name }}
  labels:
    app.kubernetes.io/name: traefik-forward-auth
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: traefik-forward-auth
  template:
    metadata:
      labels:
        app.kubernetes.io/name: traefik-forward-auth
    spec:
      containers:
        - name: forward-auth
          image: "{{ .Values.forwardAuth.image.repository }}:{{ .Values.forwardAuth.image.tag }}"
          imagePullPolicy: {{ .Values.forwardAuth.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 4181
              protocol: TCP
          env:
            # Use generic OAuth2 instead of OIDC to avoid issuer mismatch
            # Auth URL is browser-facing (external), token/user URLs are server-facing (internal)
            - name: PROVIDERS_GENERIC_OAUTH_AUTH_URL
              value: "{{ .Values.forwardAuth.authUrl }}"
            - name: PROVIDERS_GENERIC_OAUTH_TOKEN_URL
              value: "{{ .Values.forwardAuth.tokenUrl }}"
            - name: PROVIDERS_GENERIC_OAUTH_USER_URL
              value: "{{ .Values.forwardAuth.userUrl }}"
            - name: PROVIDERS_GENERIC_OAUTH_CLIENT_ID
              value: "{{ .Values.forwardAuth.clientId }}"
            - name: PROVIDERS_GENERIC_OAUTH_CLIENT_SECRET
              value: "{{ .Values.forwardAuth.clientSecret }}"
            - name: PROVIDERS_GENERIC_OAUTH_SCOPE
              value: "openid profile email"
            - name: SECRET
              value: "{{ .Values.forwardAuth.secret }}"
            - name: DEFAULT_PROVIDER
              value: "generic-oauth"
            # Specify which field from userinfo to use as user identity
            - name: USER_ID_PATH
              value: "email"
            - name: COOKIE_DOMAIN
              value: "{{ .Values.forwardAuth.cookieDomain }}"
            - name: COOKIE_NAME
              value: "{{ .Values.forwardAuth.cookieName }}"
            - name: INSECURE_COOKIE
              value: "true"
            - name: LOG_LEVEL
              value: "debug"
            - name: AUTH_HOST
              value: ""
            - name: URL_PATH
              value: "/_oauth"
          resources:
            limits:
              cpu: 100m
              memory: 64Mi
            requests:
              cpu: 50m
              memory: 32Mi
