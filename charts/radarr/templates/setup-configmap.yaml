apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "radarr.fullname" . }}-setup
  namespace: {{ .Values.namespace.name }}
  labels:
    {{- include "radarr.labels" . | nindent 4 }}
data:
  setup-downloadclients.sh: |
    #!/bin/bash
    # Setup script to manage torrent download clients in Radarr
    # Supports: qBittorrent, Transmission, Deluge, ruTorrent
    # Adds clients when available, removes when unavailable

    CONFIG_FILE="/config/config.xml"
    API_PORT="7878"
    API_BASE="/radarr"
    CHECK_INTERVAL=10

    # Download client configurations
    # Format: NAME|IMPLEMENTATION|HOST|PORT|CHECK_PATH|CATEGORY_FIELD|CATEGORY_VALUE
    CLIENTS="
    qBittorrent|QBittorrent|qbittorrent.qbittorrent.svc.cluster.local|8080|/api/v2/app/version|movieCategory|Movies
    Transmission|Transmission|transmission.transmission.svc.cluster.local|9091|/transmission/web/|movieCategory|Movies
    Deluge|Deluge|deluge.deluge.svc.cluster.local|8112|/|movieCategory|movies
    ruTorrent|RTorrent|rutorrent.rutorrent.svc.cluster.local|8000|/RPC2|movieCategory|Movies
    "

    get_api_key() {
      sed -n 's/.*<ApiKey>\([^<]*\)<\/ApiKey>.*/\1/p' "$CONFIG_FILE" 2>/dev/null
    }

    is_api_ready() {
      local api_key="$1"
      curl -s -f -H "X-Api-Key: $api_key" "http://localhost:$API_PORT$API_BASE/api/v3/system/status" > /dev/null 2>&1
    }

    is_client_available() {
      local host="$1"
      local port="$2"
      local check_path="$3"
      # For XMLRPC endpoints (like ruTorrent), use POST with a simple call
      if [ "$check_path" = "/RPC2" ]; then
        curl -s -f --connect-timeout 3 -X POST \
          -H "Content-Type: text/xml" \
          -d '<?xml version="1.0"?><methodCall><methodName>system.listMethods</methodName></methodCall>' \
          "http://$host:$port$check_path" > /dev/null 2>&1
      else
        curl -s -f --connect-timeout 3 "http://$host:$port$check_path" > /dev/null 2>&1
      fi
    }

    get_client_id() {
      local api_key="$1"
      local implementation="$2"
      curl -s -H "X-Api-Key: $api_key" "http://localhost:$API_PORT$API_BASE/api/v3/downloadclient" 2>/dev/null | \
        jq -r ".[] | select(.implementation == \"$implementation\") | .id" | head -1
    }

    add_qbittorrent() {
      local api_key="$1"
      local host="$2"
      local port="$3"
      curl -s -X POST \
        -H "X-Api-Key: $api_key" \
        -H "Content-Type: application/json" \
        "http://localhost:$API_PORT$API_BASE/api/v3/downloadclient" \
        -d '{
          "name": "qBittorrent",
          "implementation": "QBittorrent",
          "configContract": "QBittorrentSettings",
          "protocol": "torrent",
          "enable": true,
          "priority": 1,
          "fields": [
            {"name": "host", "value": "'"$host"'"},
            {"name": "port", "value": '"$port"'},
            {"name": "useSsl", "value": false},
            {"name": "movieCategory", "value": "Movies"}
          ]
        }'
    }

    add_transmission() {
      local api_key="$1"
      local host="$2"
      local port="$3"
      curl -s -X POST \
        -H "X-Api-Key: $api_key" \
        -H "Content-Type: application/json" \
        "http://localhost:$API_PORT$API_BASE/api/v3/downloadclient" \
        -d '{
          "name": "Transmission",
          "implementation": "Transmission",
          "configContract": "TransmissionSettings",
          "protocol": "torrent",
          "enable": true,
          "priority": 1,
          "fields": [
            {"name": "host", "value": "'"$host"'"},
            {"name": "port", "value": '"$port"'},
            {"name": "useSsl", "value": false},
            {"name": "urlBase", "value": "/transmission/"},
            {"name": "movieCategory", "value": "Movies"}
          ]
        }'
    }

    add_deluge() {
      local api_key="$1"
      local host="$2"
      local port="$3"
      curl -s -X POST \
        -H "X-Api-Key: $api_key" \
        -H "Content-Type: application/json" \
        "http://localhost:$API_PORT$API_BASE/api/v3/downloadclient" \
        -d '{
          "name": "Deluge",
          "implementation": "Deluge",
          "configContract": "DelugeSettings",
          "protocol": "torrent",
          "enable": true,
          "priority": 1,
          "fields": [
            {"name": "host", "value": "'"$host"'"},
            {"name": "port", "value": '"$port"'},
            {"name": "useSsl", "value": false}
          ]
        }'
    }

    add_rutorrent() {
      local api_key="$1"
      local host="$2"
      local port="$3"
      curl -s -X POST \
        -H "X-Api-Key: $api_key" \
        -H "Content-Type: application/json" \
        "http://localhost:$API_PORT$API_BASE/api/v3/downloadclient" \
        -d '{
          "name": "ruTorrent",
          "implementation": "RTorrent",
          "configContract": "RTorrentSettings",
          "protocol": "torrent",
          "enable": true,
          "priority": 1,
          "fields": [
            {"name": "host", "value": "'"$host"'"},
            {"name": "port", "value": '"$port"'},
            {"name": "useSsl", "value": false},
            {"name": "urlBase", "value": "/RPC2"},
            {"name": "movieCategory", "value": "Movies"}
          ]
        }'
    }

    add_client() {
      local api_key="$1"
      local name="$2"
      local host="$3"
      local port="$4"

      case "$name" in
        qBittorrent) add_qbittorrent "$api_key" "$host" "$port" ;;
        Transmission) add_transmission "$api_key" "$host" "$port" ;;
        Deluge) add_deluge "$api_key" "$host" "$port" ;;
        ruTorrent) add_rutorrent "$api_key" "$host" "$port" ;;
      esac
    }

    remove_client() {
      local api_key="$1"
      local client_id="$2"
      curl -s -X DELETE -H "X-Api-Key: $api_key" \
        "http://localhost:$API_PORT$API_BASE/api/v3/downloadclient/$client_id"
    }

    echo "[setup] Starting download client manager for Radarr..."

    # Wait for config file and API key
    echo "[setup] Waiting for Radarr to be ready..."
    while true; do
      API_KEY=$(get_api_key)
      if [ -n "$API_KEY" ] && is_api_ready "$API_KEY"; then
        echo "[setup] Radarr API is ready"
        break
      fi
      sleep 2
    done

    # Main loop - continuously monitor download client availability
    while true; do
      API_KEY=$(get_api_key)

      if ! is_api_ready "$API_KEY"; then
        sleep $CHECK_INTERVAL
        continue
      fi

      # Process each client
      echo "$CLIENTS" | while IFS='|' read -r name implementation host port check_path category_field category_value; do
        # Skip empty lines
        [ -z "$name" ] && continue

        # Trim whitespace
        name=$(echo "$name" | tr -d ' ')
        implementation=$(echo "$implementation" | tr -d ' ')
        host=$(echo "$host" | tr -d ' ')
        port=$(echo "$port" | tr -d ' ')
        check_path=$(echo "$check_path" | tr -d ' ')

        available=$(is_client_available "$host" "$port" "$check_path" && echo "yes" || echo "no")
        client_id=$(get_client_id "$API_KEY" "$implementation")
        exists=$([ -n "$client_id" ] && echo "yes" || echo "no")

        if [ "$available" = "yes" ] && [ "$exists" = "no" ]; then
          echo "[setup] $name is available, adding as download client..."
          response=$(add_client "$API_KEY" "$name" "$host" "$port")
          if echo "$response" | grep -q '"id"'; then
            echo "[setup] Successfully added $name"
          else
            echo "[setup] Failed to add $name"
          fi
        elif [ "$available" = "no" ] && [ "$exists" = "yes" ]; then
          echo "[setup] $name is no longer available, removing..."
          remove_client "$API_KEY" "$client_id"
          echo "[setup] Removed $name"
        fi
      done

      sleep $CHECK_INTERVAL
    done
